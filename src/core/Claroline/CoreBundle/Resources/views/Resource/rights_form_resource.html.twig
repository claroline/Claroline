{% macro showTag(tagsList, tagWorkspaces, hierarchy, index, displayable, workspaceRoles, resource) %}
{% for tag in tagsList %}
    {% if displayable[tag.getId()] %}
    {% set currentIndex = index ~ "-" ~ tag.getId() %}
    <div class="accordion" id="accordion-{{ currentIndex }}">
        <div class="accordion-group">
            <div class="accordion-heading">
                <a  class="accordion-toggle"
                    data-toggle="collapse"
                    data-parent="#accordion-{{ currentIndex }}"
                    href="#collapse-{{ currentIndex }}"
                >
                    <i class="icon-align-justify"></i>
                    {{ tag.getName() }}
                    <i class="icon-chevron-down pull-right"></i>
                </a>
            </div>
            <div id="collapse-{{ currentIndex }}" class="accordion-body collapse">
                <div class="accordion-inner">
                    {% if hierarchy[tag.getId()]|length > 0 %}
                    {{ _self.showTag(hierarchy[tag.getId()], tagWorkspaces, hierarchy, currentIndex, displayable, workspaceRoles, resource) }}
                    {% endif %}
                    <ul>
                        {% for relWorkspaceTag in tagWorkspaces[tag.id] %}
                        {% set workspace = relWorkspaceTag.getWorkspace() %}
                        <div class="accordion-group">
                            <div class="accordion-heading">
                                <a class="accordion-toggle"
                                   data-toggle="collapse"
                                   href="#collapse-{{ currentIndex }}-{{ workspace.getCode() }}">
                                    {{ workspace.getName() }}
                                    <span class="workspace-code">({{ workspace.getCode() }})</span>
                                </a>
                            </div>
                            <div id="collapse-{{ currentIndex }}-{{ workspace.getCode() }}" class="accordion-body collapse">
                                <div class="accordion-inner">
                                    <ul>
                                        {% for role in workspaceRoles[workspace.getCode()] %}
                                            <a class="workspace-role-item" href="{{ path('claro_resource_right_form', {'resource':resource.id, 'role':role.id}) }}">{{ role.getTranslationKey() }}</a><br/>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}
{% endmacro %}

{% from _self import showTag %}

<ul class="nav nav-tabs" id="rights-form-resource-nav-tabs">
    <li class="active"><a href="#general" data-toggle="tab">{{ 'general'|trans({}, 'platform') }}</a></li>
    <li><a href="#advanced" data-toggle="tab">{{ 'advanced'|trans({}, 'platform') }}</a></li>
    <li><a href="#workspaces-list" data-toggle="tab">{{ 'all_workspaces'|trans({}, 'platform') }}</a></li>
</ul>

<div class="tab-content" id="rights-form-resource-tab-content">
    <div class="tab-pane active" id="general">
        <form id="resource-rights-form" class="resource-rights-form" action="{{ path('claro_resource_rights_edit', {'resource': resource.getId()}) }}" method="post">
            <table id="perms-table" class="table table-striped table-bordered table-condensed">
                <tr>
                    <th>{{ 'role'|trans({}, 'platform') }}</th>
                    <th>{{ 'delete'|trans({}, 'platform') }}</th>
                    <th>{{ 'open'|trans({}, 'platform') }}</th>
                    <th>{{ 'edit'|trans({}, 'platform') }}</th>
                    <th>{{ 'copy'|trans({}, 'platform') }}</th>
                    <th>{{ 'export'|trans({}, 'platform') }}</th>
                    {% block createHeader %}{% endblock %}
                </tr>
                {% for permissions in roleRights %}
                <tr class="role-permissions" data-name="{{ permissions.getRole().getTranslationKey() }}">
                    <td>
                        {{ permissions.getRole().getTranslationKey()|trans({}, 'platform') }}
                        {% if permissions.getRole().getWorkspace() %}
                            <br/><em>({{ permissions.getRole().getWorkspace().getCode() }})</em>
                        {% endif %}
                    </td>
                    <td>
                        <input name="roles[{{ permissions.getRole().getId() }}][delete]" type="checkbox"
                        {% if (permissions.canDelete()) %}
                            checked
                        {% endif %}
                        />
                    </td>
                    <td>
                        <input name="roles[{{ permissions.getRole().getId() }}][open]" type="checkbox"
                        {% if permissions.canOpen() %} checked {% endif %}
                        />
                    </td>
                    <td>
                        <input name="roles[{{ permissions.getRole().getId() }}][edit]" type="checkbox"
                        {% if (permissions.canEdit()) %}
                            checked
                        {% endif %}
                        />
                    </td>
                    <td>
                        <input name="roles[{{ permissions.getRole().getId() }}][copy]" type="checkbox"
                        {% if (permissions.canCopy()) %}
                            checked
                        {% endif %}
                        />
                    </td>
                    <td>
                        <input name="roles[{{ permissions.getRole().getId() }}][export]" type="checkbox"
                        {% if (permissions.canExport()) %}
                            checked
                        {% endif %}
                        />
                    </td>
                    {% block createCell %}{% endblock %}
                </tr>
                {% endfor %}
            </table>
            {% block recursiveOption %}{% endblock %}
            <input id="submit-default-rights-form-button" type="submit" value="{{ 'ok'|trans({}, 'platform') }}" class="pull-right" />
        </form>
    </div>
    <div class="tab-pane" id="advanced">
        <input type="text" id="role-search-text"/>
        <input type="submit" value="{{ 'search'|trans({}, 'platform') }}" class="btn search-role-btn">
        <div id="advanced-pane-content">
            <div id="role-list"></div>
            <div id="form-right-wrapper"></div>
        </div>
    </div>
    <div class="tab-pane" id="workspaces-list">
        <div id="advanced-pane-content">
            <div class="accordion" id="accordion-all">
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a  class="accordion-toggle"
                            data-toggle="collapse"
                            data-parent="#accordion-all"
                            href="#collapse-all"
                        >
                            <i class="icon-align-justify"></i>
                            {{ 'all_workspaces'|trans({}, 'platform') }}
                            <i class="icon-chevron-down pull-right"></i>
                        </a>
                    </div>
                    <div id="collapse-all" class="accordion-body collapse {% if tags|length == 0 %}in{% endif %}">
                        <div class="accordion-inner">
                            <ul>
                                {% for workspace in workspaces %}
                                <div class="accordion-group">
                                    <div class="accordion-heading">
                                        <a class="accordion-toggle"
                                           data-toggle="collapse"
                                           href="#collapse-all-{{ workspace.getCode() }}">
                                            {{ workspace.getName() }}
                                            <span class="workspace-code">({{ workspace.getCode() }})</span>
                                        </a>
                                    </div>
                                    <div id="collapse-all-{{ workspace.getCode() }}" class="accordion-body collapse">
                                        <div class="accordion-inner">
                                            <ul>
                                                {% for role in workspaceRoles[workspace.getCode()] %}
                                                    <a class="workspace-role-item" href="{{ path('claro_resource_right_form', {'resource':resource.id, 'role':role.id}) }}">{{ role.getTranslationKey() }}</a><br/>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            {{ showTag(rootTags, tagWorkspaces, hierarchy, "0", displayable, workspaceRoles, resource) }}
        </div>
    </div>
</div>

<div id="modal-check-resource-right-box" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close modal-close">Ã—</button>
        <h3>{{ 'rights_management'|trans({}, 'platform') }}</h3>
    </div>
    <div class="modal-body" id="modal-check-role">
    </div>
</div>
